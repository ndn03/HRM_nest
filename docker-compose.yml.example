services:
  # ========================================================================================
  # DỊCH VỤ NESTJS - Ứng dụng chính xử lý logic nghiệp vụ HRM
  # ========================================================================================
  nest-app:
    container_name: hrm-nest-app                    # Tên container để dễ quản lý
    restart: unless-stopped                         # Tự động khởi động lại khi container bị dừng
    build:
      context: ./nest-app                          # Thư mục chứa source code NestJS
      dockerfile: Dockerfile                        # File build image từ source code
    ports:
      - "7710:3000"                                # Ánh xạ port 7710 (host) -> 3000 (container)
    env_file:
      - .env/.env.nest-app                         # File chứa biến môi trường cho ứng dụng
    environment:
      # Cấu hình kết nối database và cache trong Docker network
      - MYSQL_HOST=mysql                           # Hostname MySQL service
      - MYSQL_PORT=3306                            # Port MySQL bên trong Docker network  
      - REDIS_HOST=redis                           # Hostname Redis service
      - REDIS_PORT=6379                            # Port Redis bên trong Docker network
    depends_on:
      # Đảm bảo MySQL và Redis đã sẵn sàng trước khi start NestJS
      mysql:
        condition: service_healthy               # Chờ MySQL health check pass
      redis:
        condition: service_healthy               # Chờ Redis health check pass
    networks:
      - hrm-nest-app                               # Kết nối vào mạng nội bộ

  # ========================================================================================
  # DỊCH VỤ MYSQL - Cơ sở dữ liệu chính lưu trữ thông tin HRM
  # ========================================================================================
  mysql:
    image: mysql:8.1                              # Sử dụng MySQL phiên bản 8.1
    container_name: hrm-mysql                      # Tên container MySQL
    restart: unless-stopped                        # Tự động khởi động lại khi bị dừng
    environment:
      # Cấu hình database và user - THAY ĐỔI MẬT KHẨU TRONG MÔI TRƯỜNG PRODUCTION
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}  # Sử dụng biến môi trường
      MYSQL_DATABASE: ${MYSQL_DATABASE}            # Tên database từ biến môi trường
      MYSQL_USER: ${MYSQL_USER}                    # User từ biến môi trường
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}            # Mật khẩu từ biến môi trường
    ports:
      - "3308:3306"                               # Ánh xạ port 3308 (host) -> 3306 (container)
    volumes:
      # Mount các thư mục để lưu trữ dữ liệu và config
      - .docker/db/data:/var/lib/mysql            # Lưu trữ dữ liệu database
      - .docker/db/logs:/var/log/mysql            # Lưu trữ log MySQL
      - .docker/db/config/my.cnf:/etc/mysql/conf.d/my.cnf  # File cấu hình MySQL
      - .docker/db/sql:/docker-entrypoint-initdb.d # Script khởi tạo database ban đầu
    healthcheck:
      # Kiểm tra MySQL đã sẵn sàng nhận kết nối chưa
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 30s                               # Kiểm tra mỗi 30 giây
      timeout: 10s                                # Timeout sau 10 giây
      retries: 5                                  # Thử lại 5 lần nếu fail
      start_period: 30s                           # Đợi 30s trước khi bắt đầu health check
    networks:
      - hrm-nest-app                              # Kết nối vào mạng nội bộ

  # ========================================================================================
  # DỊCH VỤ REDIS - Cache và quản lý session
  # ========================================================================================
  redis:
    image: redis:6.2                              # Sử dụng Redis phiên bản 6.2
    container_name: hrm-redis                      # Tên container Redis
    restart: unless-stopped                        # Tự động khởi động lại khi bị dừng
    ports:
      - "7713:6379"                               # Ánh xạ port 7713 (host) -> 6379 (container)
    volumes:
      - redis_data:/data                          # Lưu trữ dữ liệu Redis vào volume
    healthcheck:
      # Kiểm tra Redis đã sẵn sàng chưa
      test: ["CMD", "redis-cli", "ping"]          # Gửi lệnh ping đến Redis
      interval: 30s                               # Kiểm tra mỗi 30 giây
      timeout: 10s                                # Timeout sau 10 giây
      retries: 5                                  # Thử lại 5 lần nếu fail
      start_period: 10s                           # Đợi 10s trước khi bắt đầu health check
    networks:
      - hrm-nest-app                              # Kết nối vào mạng nội bộ

  # ========================================================================================
  # DỊCH VỤ NGINX - Reverse proxy và load balancer
  # ========================================================================================
  nginx:
    restart: unless-stopped                        # Tự động khởi động lại khi bị dừng
    image: nginx:alpine                           # Sử dụng Nginx phiên bản Alpine (nhẹ)
    container_name: hrm-nginx                     # Tên container Nginx
    volumes:
      # Mount file cấu hình và thư mục static
      - .docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf  # File cấu hình Nginx
      - .docker/nginx/static:/static              # Thư mục chứa file static
      - .docker/nginx/logs:/var/log/nginx         # Thư mục lưu log Nginx
    ports:
      - "7714:80"                                 # Ánh xạ port 7714 (host) -> 80 (container)
    depends_on:
      - nest-app                                  # Đảm bảo NestJS đã chạy trước
    networks:
      - hrm-nest-app                              # Kết nối vào mạng nội bộ

# ========================================================================================
# QUẢN LÝ VOLUMES - Lưu trữ dữ liệu bền vững
# ========================================================================================
volumes:
  redis_data:                                     # Volume lưu trữ dữ liệu Redis
    driver: local                                 # Sử dụng driver local storage

# ========================================================================================
# QUẢN LÝ NETWORKS - Mạng nội bộ cho các container
# ========================================================================================
networks:
  hrm-nest-app:                                   # Mạng riêng cho ứng dụng HRM
    driver: bridge                                # Sử dụng bridge network driver
